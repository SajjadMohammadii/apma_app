#!/bin/bash

# ØªÙ†Ø¸ÛŒÙ… Ù…ØªØºÛŒØ± Ù¾Ø±ÙˆÚ˜Ù‡
PROJECT_DIR=$(pwd)
echo "ðŸ“ Ø¯Ø± Ø­Ø§Ù„ Ú©Ø§Ø± Ø¯Ø±: $PROJECT_DIR"

# 1. Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø´â€ŒÙ‡Ø§
echo "ðŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø´â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ..."
rm -rf ~/.gradle/caches/
rm -rf android/.gradle
rm -rf android/build
rm -rf android/app/build

# 2. ØªØµØ­ÛŒØ­ Ù†Ø³Ø®Ù‡ Gradle (Ø¨Ù‡ 8.14 Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯ Ø¨Ø±Ø§ÛŒ Flutter 3.38)
echo "ðŸ”§ ØªØµØ­ÛŒØ­ Ù†Ø³Ø®Ù‡ Gradle..."
cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOL'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.14-all.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOL

# 3. ØªØµØ­ÛŒØ­ settings.gradle.kts (Ø³Ø§Ø²Ú¯Ø§Ø± Ø¨Ø§ Flutter Ø¬Ø¯ÛŒØ¯)
echo "ðŸ“ ØªØµØ­ÛŒØ­ ØªÙ†Ø¸ÛŒÙ…Ø§Øª..."
cat > android/settings.gradle.kts << 'EOL'
pluginManagement {
    val flutterSdkPath = run {
        val properties = java.util.Properties()
        file("local.properties").inputStream().use { properties.load(it) }
        val flutterSdkPath = properties.getProperty("flutter.sdk")
        require(flutterSdkPath != null) { "flutter.sdk not set in local.properties" }
        flutterSdkPath
    }
    includeBuild("$flutterSdkPath/packages/flutter_tools/gradle")

    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
plugins {
    id("dev.flutter.flutter-plugin-loader") version "1.0.0"
    id("com.android.application") version "8.5.0" apply false  // Ø¢Ù¾Ø¯ÛŒØª Ø¨Ù‡ 8.5 Ø¨Ø±Ø§ÛŒ AGP
    id("org.jetbrains.kotlin.android") version "1.9.25" apply false  // Ø¢Ù¾Ø¯ÛŒØª Kotlin
}
include(":app")
EOL

# 4. ØªØµØ­ÛŒØ­ gradle.properties
cat > android/gradle.properties << 'EOL'
org.gradle.jvmargs=-Xmx4096M -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError
org.gradle.parallel=true
org.gradle.daemon=true
org.gradle.caching=true
android.useAndroidX=true
android.enableJetifier=true
kotlin.code.style=official
EOL

# 5. Ø¯Ø§Ù†Ù„ÙˆØ¯ gradle-wrapper.jar (Ø¨Ø±Ø§ÛŒ Ù†Ø³Ø®Ù‡ 8.14)
echo "ðŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Gradle wrapper..."
cd android
wget -q https://github.com/gradle/gradle/raw/v8.14/gradle/wrapper/gradle-wrapper.jar -O gradle/wrapper/gradle-wrapper.jar
cd ..

# 6. Flutter clean Ùˆ pub get
echo "ðŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Flutter..."
flutter clean
flutter pub get

echo "=========================================="
echo "âœ… Ù…Ø´Ú©Ù„ Ø±ÙØ¹ Ø´Ø¯!"
echo "Ø­Ø§Ù„Ø§ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯:"
echo "flutter run"
echo "=========================================="

